/**
 * @license MIT
 * Copyright (c) 2025 SGNL.ai, Inc.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
"use strict";async function t(t){const e=t.environment||{},r=t.secrets||{};if(r.BEARER_AUTH_TOKEN){const t=r.BEARER_AUTH_TOKEN;return t.startsWith("Bearer ")?t:`Bearer ${t}`}if(r.BASIC_PASSWORD&&r.BASIC_USERNAME){return`Basic ${btoa(`${r.BASIC_USERNAME}:${r.BASIC_PASSWORD}`)}`}if(r.OAUTH2_AUTHORIZATION_CODE_ACCESS_TOKEN){const t=r.OAUTH2_AUTHORIZATION_CODE_ACCESS_TOKEN;return t.startsWith("Bearer ")?t:`Bearer ${t}`}if(r.OAUTH2_CLIENT_CREDENTIALS_CLIENT_SECRET){const t=e.OAUTH2_CLIENT_CREDENTIALS_TOKEN_URL,s=e.OAUTH2_CLIENT_CREDENTIALS_CLIENT_ID,n=r.OAUTH2_CLIENT_CREDENTIALS_CLIENT_SECRET;if(!t||!s)throw new Error("OAuth2 Client Credentials flow requires TOKEN_URL and CLIENT_ID in env");const a=await async function(t){const{tokenUrl:e,clientId:r,clientSecret:s,scope:n,audience:a,authStyle:o}=t;if(!e||!r||!s)throw new Error("OAuth2 Client Credentials flow requires tokenUrl, clientId, and clientSecret");const i=new URLSearchParams;i.append("grant_type","client_credentials"),n&&i.append("scope",n),a&&i.append("audience",a);const c={"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"};if("InParams"===o)i.append("client_id",r),i.append("client_secret",s);else{const t=btoa(`${r}:${s}`);c.Authorization=`Basic ${t}`}const u=await fetch(e,{method:"POST",headers:c,body:i.toString()});if(!u.ok){let t;try{const e=await u.json();t=JSON.stringify(e)}catch{t=await u.text()}throw new Error(`OAuth2 token request failed: ${u.status} ${u.statusText} - ${t}`)}const l=await u.json();if(!l.access_token)throw new Error("No access_token in OAuth2 response");return l.access_token}({tokenUrl:t,clientId:s,clientSecret:n,scope:e.OAUTH2_CLIENT_CREDENTIALS_SCOPE,audience:e.OAUTH2_CLIENT_CREDENTIALS_AUDIENCE,authStyle:e.OAUTH2_CLIENT_CREDENTIALS_AUTH_STYLE});return`Bearer ${a}`}throw new Error("No authentication configured. Provide one of: BEARER_AUTH_TOKEN, BASIC_USERNAME/BASIC_PASSWORD, OAUTH2_AUTHORIZATION_CODE_ACCESS_TOKEN, or OAUTH2_CLIENT_CREDENTIALS_*")}var e={maxAttempts:3,retryableStatuses:[429,502,503,504],backoffMs:1e3,maxBackoffMs:1e4,backoffMultiplier:2},r={timeout:3e4,parseResponse:!0,validateStatus:t=>t<400},s=class t extends Error{constructor(e,r,s=!1,n,a){super(e),this.statusCode=r,this.retryable=s,this.responseBody=n,this.responseHeaders=a,this.name="TransmissionError",Object.setPrototypeOf(this,t.prototype)}},n=class t extends s{constructor(e,r){super(`${e} (timeout: ${r}ms)`,void 0,!0),this.name="TimeoutError",Object.setPrototypeOf(this,t.prototype)}},a=class t extends s{constructor(e,r){super(e,void 0,!0),this.name="NetworkError",r&&(this.cause=r),Object.setPrototypeOf(this,t.prototype)}},o=class t extends Error{constructor(e){super(e),this.name="ValidationError",Object.setPrototypeOf(this,t.prototype)}};function i(t,e,r){if(void 0!==r&&r>0)return Math.min(r,e.maxBackoffMs);const s=e.backoffMs*Math.pow(e.backoffMultiplier,t-1),n=Math.min(s,e.maxBackoffMs),a=.25*n,o=n-a,i=n+a;return Math.floor(Math.random()*(i-o)+o)}function c(t){if(!t)return;const e=parseInt(t,10);if(!isNaN(e))return 1e3*e;const r=new Date(t);if(!isNaN(r.getTime())){const t=r.getTime()-Date.now();return t>0?t:void 0}}function u(t,e,r){return!(e>=r.maxAttempts)&&(void 0===t||function(t,e){return e.includes(t)}(t,r.retryableStatuses))}async function l(t){return new Promise(e=>setTimeout(e,t))}function d(t){const e={};return t.forEach((t,r)=>{e[r]=t}),e}async function f(t,e){const r=await t.text();if(!e||!r)return r;const s=t.headers.get("content-type");if(s?.includes("application/json"))try{return JSON.parse(r)}catch{return r}return r}var E={invoke:async(E,p)=>{const h=function(t,e){const r=e.environment||{},s=t?.address||r.ADDRESS;if(!s)throw new Error("No URL specified. Provide address parameter or ADDRESS environment variable");return s.endsWith("/")?s.slice(0,-1):s}(E,p),T=function(t,e){return e?`${t.endsWith("/")?t.slice(0,-1):t}/${e.startsWith("/")?e.slice(1):e}`:t}(h,E.addressSuffix),m=await t(p),S=function(t){try{return JSON.parse(t)}catch(t){throw new Error(`Invalid subject JSON: ${t.message}`)}}(E.subject),y={...function(t){try{const e=JSON.parse(t);if("object"!=typeof e||null===e||Array.isArray(e))throw new Error("Event payload must be a JSON object");return e}catch(t){throw new Error(`Invalid event payload JSON: ${t.message}`)}}(E.eventPayload),event_timestamp:Math.floor(Date.now()/1e3)},A=E.subjectFormat||"SubjectInSubId",w={};if(E.customClaims){const t=function(t){try{const e=JSON.parse(t);if("object"!=typeof e||null===e||Array.isArray(e))throw new Error("Custom claims must be a JSON object");return e}catch(t){throw new Error(`Invalid custom claims JSON: ${t.message}`)}}(E.customClaims);Object.entries(t).forEach(([t,e])=>{w[t]=e})}w.aud=E.audience,w.events={[E.type]:y},"SubjectInEventClaims"===A?w.events[E.type].subject=S:w.sub_id=S;const _=await async function(t,e){const{iss:r,iat:s,jti:n,exp:a,nbf:o,...i}=e;return(r||s||n||a||o)&&console.warn("signSET: Reserved claims (iss, iat, jti, exp, nbf) are set automatically and will be ignored"),await t.crypto.signJWT(i,{typ:"secevent+jwt"})}(p,w);return await async function(t,E,p={}){if(!function(t){if("string"!=typeof t)return!1;const e=t.split(".");if(3!==e.length)return!1;const r=/^[A-Za-z0-9_-]+$/;return e.every(t=>r.test(t))}(t))throw new o("Invalid SET format: JWT must be in format header.payload.signature");let h;try{h=new URL(E)}catch{throw new o(`Invalid URL: ${E}`)}const T={authToken:p.authToken,headers:p.headers||{},timeout:p.timeout??r.timeout,parseResponse:p.parseResponse??r.parseResponse,validateStatus:p.validateStatus??r.validateStatus,retry:{...e,...p.retry||{}}},m={"Content-Type":"application/secevent+jwt",Accept:"application/json","User-Agent":"SGNL-Action-Framework/1.0"},S=function(t){if(t)return t.startsWith("Bearer ")?t:`Bearer ${t}`}(T.authToken);S&&(m.Authorization=S);const y=(A=m,w=T.headers,{...A,...w});var A,w;let _,O;for(let e=1;e<=T.retry.maxAttempts;e++)try{const r=new AbortController,s=setTimeout(()=>r.abort(),T.timeout);try{const n=await fetch(h.toString(),{method:"POST",headers:y,body:t,signal:r.signal});clearTimeout(s),O=n;const a=d(n.headers),o=await f(n,T.parseResponse);if(T.validateStatus(n.status))return{status:"success",statusCode:n.status,body:o,headers:a};if(!u(n.status,e,T.retry))return{status:"failed",statusCode:n.status,body:o,headers:a,error:`HTTP ${n.status}: ${n.statusText}`,retryable:T.retry.retryableStatuses.includes(n.status)};const E=c(a["retry-after"]),p=i(e,T.retry,E);await l(p)}catch(t){if(clearTimeout(s),_=t instanceof Error?"AbortError"===t.name?new n("Request timed out",T.timeout):new a(`Network error: ${t.message}`,t):new a("Unknown network error"),!u(void 0,e,T.retry))throw _;const r=i(e,T.retry);await l(r)}}catch(t){if(t instanceof o)throw t;_=t instanceof Error?t:new Error(String(t))}if(O){const t=d(O.headers);let e="";try{e=await f(O,T.parseResponse)}catch{e=""}return{status:"failed",statusCode:O.status,body:e,headers:t,error:_?.message||`HTTP ${O.status}: ${O.statusText}`,retryable:!0}}throw _||new s("Failed to transmit SET after all retry attempts",void 0,!0)}(_,T,{headers:{Authorization:m,"User-Agent":"SGNL-CAEP-Hub/2.0"}})},error:async(t,e)=>{const{error:r}=t;if(r.message?.includes("429")||r.message?.includes("502")||r.message?.includes("503")||r.message?.includes("504"))return{status:"retry_requested"};throw r},halt:async(t,e)=>({status:"halted"})};module.exports=E;
