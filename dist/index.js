/**
 * @license MIT
 * Copyright (c) 2025 SGNL.ai, Inc.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
"use strict";const t="SGNL-CAEP-Hub/2.0";async function e(e){const r=e.environment||{},s=e.secrets||{};if(s.BEARER_AUTH_TOKEN){const t=s.BEARER_AUTH_TOKEN;return t.startsWith("Bearer ")?t:`Bearer ${t}`}if(s.BASIC_PASSWORD&&s.BASIC_USERNAME){return`Basic ${btoa(`${s.BASIC_USERNAME}:${s.BASIC_PASSWORD}`)}`}if(s.OAUTH2_AUTHORIZATION_CODE_ACCESS_TOKEN){const t=s.OAUTH2_AUTHORIZATION_CODE_ACCESS_TOKEN;return t.startsWith("Bearer ")?t:`Bearer ${t}`}if(s.OAUTH2_CLIENT_CREDENTIALS_CLIENT_SECRET){const e=r.OAUTH2_CLIENT_CREDENTIALS_TOKEN_URL,n=r.OAUTH2_CLIENT_CREDENTIALS_CLIENT_ID,a=s.OAUTH2_CLIENT_CREDENTIALS_CLIENT_SECRET;if(!e||!n)throw new Error("OAuth2 Client Credentials flow requires TOKEN_URL and CLIENT_ID in env");const o=await async function(e){const{tokenUrl:r,clientId:s,clientSecret:n,scope:a,audience:o,authStyle:i}=e;if(!r||!s||!n)throw new Error("OAuth2 Client Credentials flow requires tokenUrl, clientId, and clientSecret");const c=new URLSearchParams;c.append("grant_type","client_credentials"),a&&c.append("scope",a),o&&c.append("audience",o);const u={"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json","User-Agent":t};if("InParams"===i)c.append("client_id",s),c.append("client_secret",n);else{const t=btoa(`${s}:${n}`);u.Authorization=`Basic ${t}`}const l=await fetch(r,{method:"POST",headers:u,body:c.toString()});if(!l.ok){let t;try{const e=await l.json();t=JSON.stringify(e)}catch{t=await l.text()}throw new Error(`OAuth2 token request failed: ${l.status} ${l.statusText} - ${t}`)}const d=await l.json();if(!d.access_token)throw new Error("No access_token in OAuth2 response");return d.access_token}({tokenUrl:e,clientId:n,clientSecret:a,scope:r.OAUTH2_CLIENT_CREDENTIALS_SCOPE,audience:r.OAUTH2_CLIENT_CREDENTIALS_AUDIENCE,authStyle:r.OAUTH2_CLIENT_CREDENTIALS_AUTH_STYLE});return`Bearer ${o}`}throw new Error("No authentication configured. Provide one of: BEARER_AUTH_TOKEN, BASIC_USERNAME/BASIC_PASSWORD, OAUTH2_AUTHORIZATION_CODE_ACCESS_TOKEN, or OAUTH2_CLIENT_CREDENTIALS_*")}var r={maxAttempts:3,retryableStatuses:[429,502,503,504],backoffMs:1e3,maxBackoffMs:1e4,backoffMultiplier:2},s={timeout:3e4,parseResponse:!0,validateStatus:t=>t<400},n=class t extends Error{constructor(e,r,s=!1,n,a){super(e),this.statusCode=r,this.retryable=s,this.responseBody=n,this.responseHeaders=a,this.name="TransmissionError",Object.setPrototypeOf(this,t.prototype)}},a=class t extends n{constructor(e,r){super(`${e} (timeout: ${r}ms)`,void 0,!0),this.name="TimeoutError",Object.setPrototypeOf(this,t.prototype)}},o=class t extends n{constructor(e,r){super(e,void 0,!0),this.name="NetworkError",r&&(this.cause=r),Object.setPrototypeOf(this,t.prototype)}},i=class t extends Error{constructor(e){super(e),this.name="ValidationError",Object.setPrototypeOf(this,t.prototype)}};function c(t,e,r){if(void 0!==r&&r>0)return Math.min(r,e.maxBackoffMs);const s=e.backoffMs*Math.pow(e.backoffMultiplier,t-1),n=Math.min(s,e.maxBackoffMs),a=.25*n,o=n-a,i=n+a;return Math.floor(Math.random()*(i-o)+o)}function u(t){if(!t)return;const e=parseInt(t,10);if(!isNaN(e))return 1e3*e;const r=new Date(t);if(!isNaN(r.getTime())){const t=r.getTime()-Date.now();return t>0?t:void 0}}function l(t,e,r){return!(e>=r.maxAttempts)&&(void 0===t||function(t,e){return e.includes(t)}(t,r.retryableStatuses))}async function d(t){return new Promise(e=>setTimeout(e,t))}function f(t){const e={};return t.forEach((t,r)=>{e[r]=t}),e}async function E(t,e){const r=await t.text();if(!e||!r)return r;const s=t.headers.get("content-type");if(s?.includes("application/json"))try{return JSON.parse(r)}catch{return r}return r}var p={invoke:async(p,h)=>{const T=function(t,e){const r=e.environment||{},s=t?.address||r.ADDRESS;if(!s)throw new Error("No URL specified. Provide address parameter or ADDRESS environment variable");return s.endsWith("/")?s.slice(0,-1):s}(p,h),m=function(t,e){return e?`${t.endsWith("/")?t.slice(0,-1):t}/${e.startsWith("/")?e.slice(1):e}`:t}(T,p.addressSuffix),S=await e(h),A=function(t){try{return JSON.parse(t)}catch(t){throw new Error(`Invalid subject JSON: ${t.message}`,{cause:t})}}(p.subject),y={...function(t){try{const e=JSON.parse(t);if("object"!=typeof e||null===e||Array.isArray(e))throw new Error("Event payload must be a JSON object");return e}catch(t){throw new Error(`Invalid event payload JSON: ${t.message}`,{cause:t})}}(p.eventPayload),event_timestamp:Math.floor(Date.now()/1e3)},w=p.subjectFormat||"SubjectInSubId",_={};if(p.customClaims){const t=function(t){try{const e=JSON.parse(t);if("object"!=typeof e||null===e||Array.isArray(e))throw new Error("Custom claims must be a JSON object");return e}catch(t){throw new Error(`Invalid custom claims JSON: ${t.message}`,{cause:t})}}(p.customClaims);Object.entries(t).forEach(([t,e])=>{_[t]=e})}_.aud=p.audience,_.events={[p.type]:y},"SubjectInEventClaims"===w?_.events[p.type].subject=A:_.sub_id=A;const O=await async function(t,e){const{iss:r,iat:s,jti:n,exp:a,nbf:o,...i}=e;return(r||s||n||a||o)&&console.warn("signSET: Reserved claims (iss, iat, jti, exp, nbf) are set automatically and will be ignored"),await t.crypto.signJWT(i,{typ:"secevent+jwt"})}(h,_);return await async function(t,e,p={}){if(!function(t){if("string"!=typeof t)return!1;const e=t.split(".");if(3!==e.length)return!1;const r=/^[A-Za-z0-9_-]+$/;return e.every(t=>r.test(t))}(t))throw new i("Invalid SET format: JWT must be in format header.payload.signature");let h;try{h=new URL(e)}catch{throw new i(`Invalid URL: ${e}`)}const T={authToken:p.authToken,headers:p.headers||{},timeout:p.timeout??s.timeout,parseResponse:p.parseResponse??s.parseResponse,validateStatus:p.validateStatus??s.validateStatus,retry:{...r,...p.retry||{}}},m={"Content-Type":"application/secevent+jwt",Accept:"application/json","User-Agent":"SGNL-Action-Framework/1.0"},S=function(t){if(t)return t.startsWith("Bearer ")?t:`Bearer ${t}`}(T.authToken);S&&(m.Authorization=S);const A=(y=m,w=T.headers,{...y,...w});var y,w;let _,O;for(let e=1;e<=T.retry.maxAttempts;e++)try{const r=new AbortController,s=setTimeout(()=>r.abort(),T.timeout);try{const n=await fetch(h.toString(),{method:"POST",headers:A,body:t,signal:r.signal});clearTimeout(s),O=n;const a=f(n.headers),o=await E(n,T.parseResponse);if(T.validateStatus(n.status))return{status:"success",statusCode:n.status,body:o,headers:a};if(!l(n.status,e,T.retry))return{status:"failed",statusCode:n.status,body:o,headers:a,error:`HTTP ${n.status}: ${n.statusText}`,retryable:T.retry.retryableStatuses.includes(n.status)};const i=u(a["retry-after"]),p=c(e,T.retry,i);await d(p)}catch(t){if(clearTimeout(s),_=t instanceof Error?"AbortError"===t.name?new a("Request timed out",T.timeout):new o(`Network error: ${t.message}`,t):new o("Unknown network error"),!l(void 0,e,T.retry))throw _;const r=c(e,T.retry);await d(r)}}catch(t){if(t instanceof i)throw t;_=t instanceof Error?t:new Error(String(t))}if(O){const t=f(O.headers);let e="";try{e=await E(O,T.parseResponse)}catch{e=""}return{status:"failed",statusCode:O.status,body:e,headers:t,error:_?.message||`HTTP ${O.status}: ${O.statusText}`,retryable:!0}}throw _||new n("Failed to transmit SET after all retry attempts",void 0,!0)}(O,m,{headers:{Authorization:S,"User-Agent":t}})},error:async(t,e)=>{const{error:r}=t;if(r.message?.includes("429")||r.message?.includes("502")||r.message?.includes("503")||r.message?.includes("504"))return{status:"retry_requested"};throw r},halt:async(t,e)=>({status:"halted"})};module.exports=p;
